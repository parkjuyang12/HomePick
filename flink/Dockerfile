FROM flink:1.18.1-scala_2.12-java11

USER root

# Python + pip + curl
RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    curl \
    openjdk-11-jdk-headless \
    && ln -sf /usr/bin/python3 /usr/bin/python \
    && rm -rf /var/lib/apt/lists/*

# ğŸ”¥ pemja ìŠ¤í‚µ (ì ˆëŒ€ ìœ„ì¹˜ ì¤‘ìš”)
ENV FLINK_PYTHON_REQUIREMENTS_SKIP_PEMJA=1

# pemja ë¹Œë“œê°€ ê¸°ëŒ€í•˜ëŠ” ê²½ë¡œì— JDK í—¤ë” ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± (arm64 ê¸°ì¤€ ê²½ë¡œ ê³ ì •)
RUN mkdir -p /opt/java && \
    rm -rf /opt/java/openjdk && \
    ln -s /usr/lib/jvm/java-11-openjdk-arm64 /opt/java/openjdk

# Python íŒ¨í‚¤ì§€ ì„¤ì¹˜ (PyFlink í¬í•¨)
COPY requirements.txt /opt/flink/requirements.txt
RUN python -m pip install --no-cache-dir \
    apache-flink==1.18.1 \
    -r /opt/flink/requirements.txt \
    google \
    grpcio==1.59.3 \
    grpcio-tools==1.59.3

# Flink Kafka Connector (1.18 ëŒ€ì‘)
RUN curl -fSL \
    https://repo1.maven.org/maven2/org/apache/flink/flink-connector-kafka/3.0.1-1.18/flink-connector-kafka-3.0.1-1.18.jar \
    -o /opt/flink/lib/flink-connector-kafka.jar

# Kafka Client (OffsetResetStrategy í¬í•¨)
RUN curl -fSL \
    https://repo1.maven.org/maven2/org/apache/kafka/kafka-clients/3.6.1/kafka-clients-3.6.1.jar \
    -o /opt/flink/lib/kafka-clients.jar

# Flink Elasticsearch Connector (1.18 ëŒ€ì‘)
RUN curl -fSL \
    https://repo1.maven.org/maven2/org/apache/flink/flink-connector-elasticsearch7/3.1.0-1.18/flink-connector-elasticsearch7-3.1.0-1.18.jar \
    -o /opt/flink/lib/flink-connector-elasticsearch7.jar

RUN chown flink:flink /opt/flink/lib/*.jar
USER flink
